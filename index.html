<script type="text/babel">
    // =========================================================
    //  ❤️ CONFIGURACIÓN FIREBASE (Unificada) ❤️
    // =========================================================
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
    import { getStorage, ref, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-storage.js";
    import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
    import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDUToiwZx4f6sI0DrYQt9kdNT-jlxlKeys",
        authDomain: "proyeccion-boda.firebaseapp.com",
        projectId: "proyeccion-boda",
        storageBucket: "proyeccion-boda.firebasestorage.app",
        messagingSenderId: "163164812654",
        appId: "1:163164812654:web:ffa2b0042f19f1fa0d7d7f"
    };

    // Inicializar Firebase
    const app = initializeApp(firebaseConfig);
    const storage = getStorage(app);
    const db = getFirestore(app);
    const auth = getAuth(app);

    // Autenticación Anónima automática al cargar
    signInAnonymously(auth).catch((error) => console.error("Error Auth:", error));

    // =========================================================
    // COMPONENTES UI (Iconos)
    // =========================================================
    const IconImageSymbol = (props) => (
        <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><rect width="18" height="18" x="3" y="3" rx="2" ry="2"/><circle cx="9" cy="9" r="2"/><path d="m21 15-3.086-3.086a2 2 0 0 0-2.828 0L6 21"/></svg>
    );
    const IconX = (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M18 6 6 18"/><path d="m6 6 12 12"/></svg>;
    const IconHeart = (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="currentColor" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M19 14c1.49-1.46 3-3.21 3-5.5A5.5 5.5 0 0 0 16.5 3c-1.76 0-3 .5-4.5 2-1.5-1.5-2.74-2-4.5-2A5.5 5.5 0 0 0 2 8.5c0 2.3 1.5 4.05 3 5.5l7 7Z"/></svg>;
    const IconLoader = (props) => <svg xmlns="http://www.w3.org/2000/svg" width={props.size || 24} height={props.size || 24} viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth={props.strokeWidth || 2} strokeLinecap="round" strokeLinejoin="round" className={props.className}><path d="M21 12a9 9 0 1 1-6.219-8.56"/></svg>;

    // =========================================================
    // LÓGICA DE LA APLICACIÓN
    // =========================================================
    const { useState, useEffect, useRef } = React;
    const ACCENT_COLOR = 'text-amber-600';

    function App() {
        const [uploading, setUploading] = useState(false);
        const [uploadStatus, setUploadStatus] = useState(null);
        const [selectedImage, setSelectedImage] = useState(null);
        const [previewUrl, setPreviewUrl] = useState(null);
        const [guestName, setGuestName] = useState('');
        const [dedication, setDedication] = useState(''); 
        const [gallery, setGallery] = useState([]);
        
        const fileInputRef = useRef(null); 

        // Carga inicial galería local
        useEffect(() => {
            const savedGallery = JSON.parse(localStorage.getItem('local_wedding_gallery') || '[]');
            setGallery(savedGallery);
        }, []);

        const handleCameraClick = () => {
            if(fileInputRef.current) {
                fileInputRef.current.setAttribute('capture', 'environment');
                fileInputRef.current.click();
            }
        };

        const handleGalleryClick = () => {
            if(fileInputRef.current) {
                fileInputRef.current.removeAttribute('capture');
                fileInputRef.current.click();
            }
        };

        const handleFileChange = (e) => {
            const file = e.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onloadend = () => {
                    setSelectedImage({ file: file, base64: reader.result });
                    setPreviewUrl(reader.result);
                    setUploadStatus(null);
                };
                reader.readAsDataURL(file);
            }
        };

        const clearSelection = () => {
            setSelectedImage(null);
            setPreviewUrl(null);
            setDedication(''); 
        };

        const handleUpload = async () => {
            if (!selectedImage) return;
            setUploading(true);
            setUploadStatus(null);

            const timestamp = new Date().getTime();
            const cleanName = (guestName || 'Invitado').replace(/[^a-zA-Z0-9]/g, '').substring(0, 20);
            // Nombre archivo: timestamp_nombre_random
            const fileName = `${timestamp}_${cleanName}.jpg`;

            try {
                // 1. Subir Imagen a Firebase Storage
                const storageRef = ref(storage, 'bodafotos/' + fileName);
                const snapshot = await uploadBytes(storageRef, selectedImage.file);
                const downloadURL = await getDownloadURL(snapshot.ref);

                // 2. Guardar datos en Firestore (Base de datos)
                await addDoc(collection(db, "photos"), {
                    url: downloadURL,
                    author: guestName || 'Invitado',
                    message: dedication,
                    timestamp: serverTimestamp() // Importante para el orden
                });
                
                handleSuccess(downloadURL, timestamp);

            } catch (error) {
                console.error("Error subida:", error);
                setUploadStatus({ type: 'error', message: 'Error al subir. Verifica tu conexión.' });
            } finally {
                setUploading(false);
            }
        };

        const handleSuccess = (url, id) => {
            setUploadStatus({ 
                type: 'success', 
                message: '¡Foto subida con éxito! Aparecerá en pantalla pronto.' 
            });
            const newPic = { 
                url: url, 
                author: guestName || 'Anónimo', 
                message: dedication, 
                id: id 
            };
            const newGallery = [newPic, ...gallery];
            setGallery(newGallery);
            localStorage.setItem('local_wedding_gallery', JSON.stringify(newGallery));
            clearSelection();
        };

        return (
            <div className="min-h-screen bg-[#f8f5f0] text-gray-800">
                <header className="fixed top-0 left-0 right-0 z-10 px-4 pt-4 pb-2 bg-[#f8f5f0]">
                     <div className="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-amber-400 via-yellow-500 to-amber-400"></div>
                </header>
                
                <main className="max-w-md mx-auto p-4 pb-16 pt-10"> 
                    <div className="bg-white rounded-3xl shadow-xl p-6 border border-gray-100">
                        <input type="file" accept="image/*" ref={fileInputRef} onChange={handleFileChange} className="hidden" />

                        {uploadStatus && (
                            <div className={`mb-4 p-3 rounded-xl flex items-center gap-2 text-sm font-medium animate-fadeIn
                                ${uploadStatus.type === 'success' ? 'bg-green-50 text-green-700 border border-green-200' : 'bg-red-50 text-red-700 border border-red-200'}`}>
                                {uploadStatus.type === 'success' ? <IconHeart className="text-green-500 fill-green-500" size={20} /> : <IconX size={20} />}
                                {uploadStatus.message}
                            </div>
                        )}

                        {!selectedImage ? (
                            <div className="text-center">
                                <div className="mb-6 flex flex-col items-center pt-2">
                                    <h1 className="font-serif text-6xl font-extrabold text-gray-800 tracking-wide leading-none">Nuestra Boda</h1>
                                    <p className="text-gray-400 font-light text-xs tracking-[.4em] uppercase mt-3 mb-6">ALBUM COLABORATIVO</p>
                                </div>
                                <div className="flex flex-col items-center mb-6 animate-fadeIn">
                                    <div className="w-24 h-24 rounded-full border-4 border-dashed border-amber-200 flex items-center justify-center mb-4 text-amber-500">
                                        <IconImageSymbol size={40} strokeWidth={1.5} />
                                    </div>
                                    <h2 className="text-2xl font-serif font-bold text-gray-800 mb-1">Captura el Momento</h2>
                                    <p className="text-gray-500 text-sm">Toca el botón para tomar una foto.</p>
                                </div>
                                
                                <div className="flex w-full h-[50px] shadow-lg border border-amber-600 rounded-xl overflow-hidden">
                                    <button onClick={handleCameraClick} className="w-1/2 bg-amber-600 text-white font-bold flex items-center justify-center hover:bg-amber-700 active:scale-[0.99] transition-all duration-150 text-sm">Cámara</button>
                                    <button onClick={handleGalleryClick} className="w-1/2 bg-white text-amber-600 font-bold flex items-center justify-center hover:bg-amber-50 active:scale-[0.99] transition-all duration-150 text-sm border-l border-amber-600">Galería</button>
                                </div>
                            </div>
                        ) : (
                            <div className="space-y-4 animate-fadeIn">
                                <div className="relative rounded-2xl overflow-hidden aspect-[4/3] shadow-lg">
                                    <img src={previewUrl} className="w-full h-full object-cover" alt="Previsualización" />
                                    <button onClick={clearSelection} className="absolute top-3 right-3 bg-black/50 text-white p-2 rounded-full hover:bg-black/70 transition-colors"><IconX size={18} /></button>
                                </div>
                                <input type="text" value={guestName} onChange={(e) => setGuestName(e.target.value)} placeholder="Tu nombre (opcional)" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500" />
                                <textarea value={dedication} onChange={(e) => setDedication(e.target.value)} placeholder="Dedicatoria..." rows="3" className="w-full p-3 bg-gray-50 border rounded-xl outline-none focus:ring-2 focus:ring-amber-500 resize-none"></textarea>
                                <button onClick={handleUpload} disabled={uploading} className={`w-full h-[50px] rounded-xl font-bold text-white flex justify-center items-center gap-2 shadow-xl transition-all duration-150 text-sm ${uploading ? 'bg-gray-400 cursor-not-allowed' : 'bg-amber-600 hover:bg-amber-700 active:scale-[0.99]'}`}>
                                    {uploading ? <><span className="animate-spin"><IconLoader size={20}/></span> Subiendo...</> : <>Enviar Foto</>}
                                </button>
                            </div>
                        )}
                    </div>
                </main>
            </div>
        );
    }

    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
</script>
