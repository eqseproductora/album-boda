<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Nuestra Boda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,400;0,600;1,400;0,800&family=Inter:wght@300;400;600;700;800;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8f5f0; }
        .font-serif { font-family: 'Playfair Display', serif; }
        .animate-fadeIn { animation: fadeIn 0.4s ease-out forwards; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="antialiased">
    <div id="root"></div>

    <script type="text/babel" data-type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, collection, addDoc, serverTimestamp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";

        // --- CONFIGURACIÃ“N (Solo Database) ---
        const firebaseConfig = {
            apiKey: "AIzaSyDUToiwZx4f6sI0DrYQt9kdNT-jlxlKeys",
            authDomain: "proyeccion-boda.firebaseapp.com",
            projectId: "proyeccion-boda",
            storageBucket: "proyeccion-boda.firebasestorage.app",
            messagingSenderId: "163164812654",
            appId: "1:163164812654:web:ffa2b0042f19f1fa0d7d7f"
        };

        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        signInAnonymously(auth).catch((error) => console.error("Error Auth:", error));

        // --- UTILIDAD DE COMPRESIÃ“N (EL TRUCO) ---
        const compressImage = (file) => {
            return new Promise((resolve) => {
                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = (e) => {
                    const img = new Image();
                    img.src = e.target.result;
                    img.onload = () => {
                        const canvas = document.createElement('canvas');
                        const MAX_WIDTH = 600; // Reducimos para que quepa en BD
                        const scale = MAX_WIDTH / img.width;
                        canvas.width = MAX_WIDTH;
                        canvas.height = img.height * scale;
                        const ctx = canvas.getContext('2d');
                        ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
                        // Convertir a texto base64 ligero
                        resolve(canvas.toDataURL('image/jpeg', 0.6));
                    };
                };
            });
        };

        const { useState, useRef } = React;

        function App() {
            const [status, setStatus] = useState('idle'); // idle, uploading, success, error
            const [preview, setPreview] = useState(null);
            const [guestName, setGuestName] = useState('');
            const fileInputRef = useRef(null);

            const handleFileSelect = async (e) => {
                const file = e.target.files[0];
                if (file) {
                    setStatus('idle');
                    // PrevisualizaciÃ³n rÃ¡pida
                    const reader = new FileReader();
                    reader.onload = (ev) => setPreview(ev.target.result);
                    reader.readAsDataURL(file);
                }
            };

            const handleUpload = async () => {
                if (!fileInputRef.current.files[0]) return;
                setStatus('uploading');

                try {
                    // 1. Comprimir la imagen en el celular
                    const base64Image = await compressImage(fileInputRef.current.files[0]);

                    // 2. Guardar TEXTO en la base de datos (Saltamos Storage)
                    await addDoc(collection(db, "photos"), {
                        url: base64Image, // Guardamos la foto entera aquÃ­
                        author: guestName || 'Invitado',
                        timestamp: serverTimestamp()
                    });

                    setStatus('success');
                    setPreview(null);
                    setGuestName('');
                    fileInputRef.current.value = null; // Reset input
                    setTimeout(() => setStatus('idle'), 3000);

                } catch (error) {
                    console.error(error);
                    setStatus('error');
                }
            };

            return (
                <div className="min-h-screen p-6 flex flex-col items-center justify-center">
                    <div className="w-full max-w-sm bg-white rounded-3xl shadow-2xl p-6 text-center border-4 border-amber-100">
                        <h1 className="font-serif text-4xl font-bold text-gray-800 mb-2">Nuestra Boda</h1>
                        <p className="text-amber-600 tracking-widest text-xs uppercase mb-8 font-bold">Sube tu foto a la pantalla</p>

                        {!preview ? (
                            <button onClick={() => fileInputRef.current.click()} className="w-full py-12 border-2 border-dashed border-amber-300 rounded-2xl bg-amber-50 hover:bg-amber-100 transition-colors flex flex-col items-center gap-2 group">
                                <span className="text-4xl group-hover:scale-110 transition-transform">ðŸ“¸</span>
                                <span className="text-amber-700 font-semibold">Tocar para tomar foto</span>
                            </button>
                        ) : (
                            <div className="space-y-4 animate-fadeIn">
                                <img src={preview} className="w-full h-48 object-cover rounded-xl shadow-md" />
                                <input type="text" value={guestName} onChange={e => setGuestName(e.target.value)} placeholder="Tu nombre (opcional)" className="w-full p-3 bg-gray-50 border border-gray-200 rounded-xl focus:ring-2 focus:ring-amber-400 outline-none" />
                                
                                {status === 'uploading' && <p className="text-amber-600 font-bold animate-pulse">Enviando...</p>}
                                {status === 'error' && <p className="text-red-500 font-bold">Error. Revisa tu internet.</p>}
                                {status === 'success' && <div className="p-3 bg-green-100 text-green-700 rounded-xl font-bold">Â¡Foto Enviada! ðŸŽ‰</div>}
                                
                                {status !== 'success' && (
                                    <div className="flex gap-2">
                                        <button onClick={() => setPreview(null)} className="flex-1 py-3 bg-gray-200 rounded-xl font-bold text-gray-600">Cancelar</button>
                                        <button onClick={handleUpload} disabled={status === 'uploading'} className="flex-1 py-3 bg-amber-600 text-white rounded-xl font-bold shadow-lg hover:bg-amber-700">
                                            {status === 'uploading' ? '...' : 'Enviar'}
                                        </button>
                                    </div>
                                )}
                            </div>
                        )}
                        <input type="file" ref={fileInputRef} onChange={handleFileSelect} accept="image/*" className="hidden" />
                    </div>
                </div>
            );
        }

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
