<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Álbum en Vivo - Nuestra Boda</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@700&family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <style>
        /* Estilos generales del carrusel */
        :root {
            --color-primary: #a0522d; /* Color arena/tierra */
            --color-secondary: #f5e9d9; /* Blanco roto/crema */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-secondary);
            color: #333;
            overflow: hidden; /* Ocultar barras de desplazamiento */
        }
        .header-title {
            font-family: 'Playfair Display', serif;
            font-size: 4rem;
            color: var(--color-primary);
            text-shadow: 2px 2px 5px rgba(0, 0, 0, 0.1);
        }
        /* Contenedor del Carrusel */
        .carousel-container {
            display: flex;
            transition: transform 0.5s ease-in-out;
            width: 100%;
            height: 100%;
        }
        /* Estilos de la diapositiva */
        .slide {
            flex-shrink: 0; /* No encoger las diapositivas */
            width: 100vw;
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        /* Estilo de la imagen */
        .slide-image {
            object-fit: contain; /* Asegura que la imagen completa se vea */
            max-width: 90%;
            max-height: 90%;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            transform: scale(0.95);
            transition: transform 0.8s ease-out;
        }
        .slide-image.active {
            transform: scale(1);
        }
        /* Efecto de carga/mensaje */
        #loading-message {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: var(--color-primary);
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.9);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>
<body class="p-0 m-0">

    <div id="proyector-app" class="w-screen h-screen flex flex-col items-center justify-center p-0 m-0">
        
        <!-- Carrusel de Diapositivas -->
        <div class="overflow-hidden w-full h-full relative">
            <div id="carousel-inner" class="carousel-container">
                <!-- Las fotos se insertarán aquí -->
            </div>
            
            <div id="loading-message">Cargando Álbum...</div>
        </div>
        
    </div>

    <script>
        // ¡URL DE APPS SCRIPT INSERTADA!
        const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwK4uck5IEiIRJAvs_NNT-cORUa_sc5vPLnwl8pSpNddYOwMMUugbu1co1DQY3pPMGg/exec"; 

        const carouselInner = document.getElementById('carousel-inner');
        const loadingMessage = document.getElementById('loading-message');
        let photos = [];
        let currentIndex = 0;
        let slideInterval;
        const SLIDE_DURATION_MS = 6000; // Mostrar cada foto por 6 segundos
        const REFRESH_RATE_MS = 30000; // Comprobar nuevas fotos cada 30 segundos

        /**
         * 1. Fetches the latest photo URLs from Google Apps Script.
         */
        async function fetchPhotos() {
            try {
                // Llamamos a la función getLatestPhotos en el Apps Script con el parámetro action=get_photos
                const response = await fetch(`${APPS_SCRIPT_URL}?action=get_photos`);
                
                // 1b. Verificar si la respuesta HTTP es exitosa
                if (!response.ok) {
                    loadingMessage.innerHTML = `<h4>ERROR HTTP: ${response.status}</h4><p>No se pudo conectar con Apps Script.<br>Verifica los permisos de despliegue (debe ser 'Cualquier persona').</p>`;
                    loadingMessage.classList.remove('hidden');
                    throw new Error(`Error HTTP: ${response.status}. Asegúrate de que el Apps Script está desplegado con acceso: "Cualquier persona".`);
                }
                
                const newPhotos = await response.json();
                
                if (newPhotos.length > 0) {
                    // Si las nuevas fotos son diferentes o hay más, actualizamos
                    const currentPhotoUrls = photos.map(p => p.url);
                    const incomingPhotoUrls = newPhotos.map(p => p.url);

                    // Solo actualizamos si hay diferencia o si es la primera carga
                    if (photos.length === 0 || JSON.stringify(currentPhotoUrls) !== JSON.stringify(incomingPhotoUrls)) {
                        photos = newPhotos;
                        renderCarousel();
                        loadingMessage.classList.add('hidden');
                        if (!slideInterval) {
                            startCarousel();
                        }
                    }
                } else {
                    loadingMessage.textContent = "Esperando la primera foto...";
                    loadingMessage.classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error al obtener fotos:", error);
                // Si el error no es HTTP, es un error de red o CORS/JSON malformado
                if (!loadingMessage.innerHTML.includes("ERROR HTTP")) {
                    loadingMessage.innerHTML = `<h4>Error de Red/JSON</h4><p>Asegúrate de que el Apps Script devuelva JSON válido y que no haya problemas de red.</p>`;
                }
                loadingMessage.classList.remove('hidden');
            }
        }

        /**
         * 2. Renders all fetched photos into the carousel structure.
         */
        function renderCarousel() {
            carouselInner.innerHTML = '';
            photos.forEach((photo, index) => {
                const slide = document.createElement('div');
                slide.className = 'slide';
                slide.dataset.index = index;
                
                const image = document.createElement('img');
                image.className = 'slide-image';
                // Añadimos un timestamp para forzar al navegador a cargar la última versión de la imagen
                // El campo 'date' del JSON se usa como timestamp para forzar la recarga
                image.src = photo.url + (photo.url.includes('?') ? '&' : '?') + 'timestamp=' + photo.date; 
                image.alt = `Foto de la boda ${index + 1}`;
                
                slide.appendChild(image);
                carouselInner.appendChild(slide);
            });
            // Reiniciar el carrusel para mostrar la primera foto
            currentIndex = 0;
            updateCarousel();
        }

        /**
         * 3. Moves the carousel to the next slide and updates the view.
         */
        function updateCarousel() {
            if (photos.length === 0) return;

            // Asegurar que el índice esté dentro de los límites
            currentIndex = currentIndex % photos.length;

            // Calcular el desplazamiento necesario (100vw por cada diapositiva)
            const offset = -currentIndex * 100;
            carouselInner.style.transform = `translateX(${offset}vw)`;
            
            // Efecto de escala en la imagen activa
            document.querySelectorAll('.slide-image').forEach(img => img.classList.remove('active'));
            const activeSlide = carouselInner.querySelector(`.slide[data-index="${currentIndex}"] img`);
            if (activeSlide) {
                activeSlide.classList.add('active');
            }
        }

        /**
         * 4. Starts the automatic slide show and photo refresh timer.
         */
        function startCarousel() {
            if (slideInterval) clearInterval(slideInterval);
            
            slideInterval = setInterval(() => {
                currentIndex++;
                updateCarousel();
            }, SLIDE_DURATION_MS);
        }

        // --- Inicio de la Aplicación ---
        
        // 1. Cargar las fotos iniciales
        fetchPhotos();

        // 2. Establecer el intervalo para refrescar las fotos (recargar las nuevas)
        setInterval(fetchPhotos, REFRESH_RATE_MS);
        
        // 3. Manejar el redimensionamiento de la ventana para mantener el diseño
        window.addEventListener('resize', updateCarousel);

    </script>
</body>
</html>
